# Author: Paulo Souza, Shahzeb Siddiqui

# docker-bootstrap:
# Copyright (c) 2015-2016, Gregory M. Kurtzer. All rights reserved.
# 
# "Singularity" Copyright (c) 2016, The Regents of the University of California,
# through Lawrence Berkeley National Laboratory (subject to receipt of any
# required approvals from the U.S. Dept. of Energy).  All rights reserved.

BootStrap: docker
From: centos
Include: yum


%post

		export EASYBUILD_INSTALLPATH=/app

		# scratch space to build and download source files from eb
		export EASYBUILD_PREFIX=/scratch

		mkdir -p $EASYBUILD_PREFIX
                mkdir -p $EASYBUILD_INSTALLPATH

		chmod 777 $EASYBUILD_PREFIX
		chmod 777 $EASYBUILD_INSTALLPATH

		# install some basic tools, need this for building basic programs like binutils
		yum groupinstall -y 'Development Tools'

                # install csh/tcsh shell
                yum install tcsh -y
 
                # epel.repo needed for Lmod and python2-pip
                yum install -y epel-release
                yum install -y Lmod

		# eb dependencies
		yum install -y which

                yum install -y python-pip
                pip install --upgrade pip
                pip install -U setuptools
                pip install -U easybuild

		
                useradd easybuild
		# run all commands as singularity user
 	        # runuser singularity -c "export EASYBUILD_ROBOT_PATHS=/usr/easybuild/easyconfigs/; eb --show-full-config; eb binutils-2.26.eb --robot "
 	        runuser easybuild -l -c "eb binutils-2.26.eb --robot --prefix=/scratch --installpath=/app"
 
%runscript
                eval "$@"

%environment
    source /etc/bashrc 
    SOFTWARE_NAME=binutil
    SOFTWARE_VERSION=2.26
    module use /app/modules/all
    module load ${SOFTWARE_NAME}/${SOFTWARE_VERSION}



